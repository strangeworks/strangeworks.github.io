<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing software on "dead" technologies | Bots on Rails. Part one: looking for an idea and setting things up.</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="Bots on Rails. Part one: looking for an idea and setting things up.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://nohype.tech/posts/bots-on-rails-part-1">
  <meta property="og:description" content="">
  <meta property="og:site_name" content="Writing software on "dead" technologies">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="http://nohype.tech/posts/bots-on-rails-part-1">
  <meta name="twitter:title" content="Bots on Rails. Part one: looking for an idea and setting things up.">
  <meta name="twitter:description" content="">

  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png">
  <link href="http://nohype.tech/feed.xml" type="application/rss+xml" rel="alternate" title="Writing software on "dead" technologies Last 10 blog posts" />

  
    <link type="text/css" rel="stylesheet" href="/assets/light.css">
  
</head>

<body>
  <main role="main">
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav reveal">
  <a href="/" class="header-logo" title="Writing software on "dead" technologies">Writing software on "dead" technologies</a>
  <ul class="header-links">
    
    
      <li>
        <a href="https://twitter.com/makefunstuff" target="_blank" title="Twitter">
          <span class="icon icon-social-twitter"></span>
        </a>
      </li>
    
    
    
      <li>
        <a href="https://github.com/strangeworks" target="_blank" title="GitHub">
          <span class="icon icon-social-github"></span>
        </a>
      </li>
    
    
    
    
      <li>
        <a href="https://www.linkedin.com/in/plugataryov-yura-b1271064" target="_blank" title="LinkedIn">
          <span class="icon icon-social-linkedin"></span>
        </a>
      </li>
    
    
    
      <li>
        <a href="mailto:plugatariov@gmail.com" title="Email">
          <span class="icon icon-at"></span>
        </a>
      </li>
    
    
      <li>
        <a href="/feed.xml" target="_blank" title="RSS">
          <span class="icon icon-social-rss"></span>
        </a>
      </li>
    
    <li>
      <a href="/about" title="About me">
        <span class="icon icon-person"></span>
      </a>
    </li>
  </ul>
</nav>

        <article class="article reveal">
          <header class="article-header">
            <h1>Bots on Rails. Part one: looking for an idea and setting things up.</h1>
            <p></p>
            <div class="article-list-footer">
              <span class="article-list-date">
                March 9, 2017
              </span>
              <span class="article-list-divider">-</span>
              <span class="article-list-minutes">
                
                
                  7 minute read
                
              </span>
              <span class="article-list-divider">-</span>
              <div class="article-list-tags">
                
                  <a href="/tag/ruby">ruby</a>
                
                  <a href="/tag/rails">rails</a>
                
              </div>
            </div>
          </header>

          <div class="article-content">
            <p><a href="/assets/posts/bots-header-1.png" class="fluidbox-trigger">
  <img src="/assets/posts/bots-header-1.png" alt="Bots header" />
</a></p>

<p>Messenger bots still one of the most hot discussed 
topic in tech community. Buzzwords such as «conversational commerce» can not be unseen.</p>

<h3 id="so-whats-messenger-bot-really-is">So what’s messenger bot really is?</h3>
<p>Conceptually messenger bots are simple webhook
handling services, that can be done in every 
technology you prefer. I personally prefer rails, 
and in this introductory tutorial I would like to share some concepts 
how fun building Facebook messenger bot can be on Rails.</p>

<h3 id="everything-starts-from-an-idea">Everything starts from an idea.</h3>
<p><a href="/assets/posts/idea.png" class="fluidbox-trigger">
  <img src="/assets/posts/idea.png" alt="Idea of bot" />
</a></p>

<p>Currently across the web there are bunch of naive bot examples that shows 
weather forecasts, food delivery, or simple echo services. 
I wouldn’t say that weather forecast bot examples is boring 
but we would like to build something where we can both play with 
as many interactions as possible and touch some fancy stuff 
from Facebook messenger API. So what are we going to build? 
We want to build something less boring and doable in the same time. 
And the first thing that came to my mind was concept of life log 
where you prompted with a simple question and just send small 
sentence about your day. Sounds pretty simple, huh? So let’s first 
describe our user flow:</p>

<ul>
  <li>
    <p>When I write message to bot I would like start conversation and get some introductory message.</p>
  </li>
  <li>
    <p>After that I would like to see what bot can do.</p>
  </li>
  <li>
    <p>Then after success on-boarding I would like to setup it first</p>
  </li>
  <li>
    <p>During this setup phase bot will prompt me when I would like to be prompted to give life log sentence of this day.</p>
  </li>
  <li>
    <p>Then I would like to be asked about my mood, and I can pick it from emoji smileys list.</p>
  </li>
  <li>
    <p>After that bot will respond with some clever answer and store this message for future reference.</p>
  </li>
</ul>

<p>This flow looks very simple and straightforward, 
how can we make it more fancier? Let’s add additional requirement, 
I would like to ask bot in natural language: “What I did two days ago?”, 
and bot will send me clickable button that will open web view with my activity page.</p>

<h3 id="preparing-our-toolbox">Preparing our toolbox</h3>
<p><a href="/assets/posts/toolbox.png" class="fluidbox-trigger">
  <img src="/assets/posts/toolbox.png" alt="Bot toolbox" />
</a></p>

<p>Fortunately, thanks to great ruby and rails community we 
will not start building our own Facebook messenger API payload 
parsers and we will use very great library 
<a href="https://github.com/hyperoslo/facebook-messenger">hyperoslo/facebook-messenger</a>, 
which gives the most important 
toolset out of the box. Returning to our requirements 
we will also need to find out how to parse natural language 
and provide proper responses from bot to end user, and fortunately 
for this we can leverage some awesomeness of wit.ai, that gives pretty 
great natural language api absolutely for free.</p>

<h3 id="building-our-dummy-bot">Building our dummy bot</h3>
<p>We have all the needed toolset, so the main question is 
how to get started? What do we need first, 
let’s think about our checklist:</p>

<ul>
  <li>
    <p>Facebook requires to have a separate Facebook page, and facebook app that can be created in facebook developer center</p>
  </li>
  <li>
    <p>To start processing messages we will need service that will handle webhooks sent from facebook, for this purpose will write our rails app.</p>
  </li>
  <li>
    <p>Our bot requires some persistence layer to ‘remember’ all settings and data the we will provide from conversation flow, so we will need some database, in our case we can use heroku.</p>
  </li>
</ul>

<h4 id="setting-everything-up-on-facebook-side">Setting everything up on Facebook side.</h4>
<p><a href="/assets/posts/facebook-page-setup.png" class="fluidbox-trigger">
  <img src="/assets/posts/facebook-page-setup.png" alt="Idea of bot" />
</a></p>

<ul>
  <li>
    <p>First you need to create your own Facebook page which will represent your bot. You can do it by visiting this link</p>
  </li>
  <li>
    <p>In order to start working with webhook processing we need to create an Facebook app that can be done by following developers.facebook.com.</p>
  </li>
</ul>

<p><a href="/assets/posts/facebook-add-product.png" class="fluidbox-trigger">
  <img src="/assets/posts/facebook-add-product.png" alt="Add facebook product" />
</a></p>

<ul>
  <li>After you have created your app you will need to add messenger platform support, this can be done by clicking add product menu item at the sidebar. And now you will have almost everything you need from facebook side, we will return to developer center a bit later and now we will need finally to dive into our rails app.</li>
</ul>

<h4 id="building-simple-rails-app">Building simple rails app.</h4>
<p>I will not describe everything what you need to do for setting up rails app, 
I expect that you have already familiar with rails and can create new rails app by yourself. 
If you don’t want to do this you can also clone <a href="https://github.com/strangeworks/lifelog-bot">this repo</a> where all the starter files are already provided. After you setup rails and all required dependencies you will need to make sure that all required dependencies works properly.</p>

<p>Make sure that you have added
<code class="highlighter-rouge">gem 'facebook-messenger'</code> 
to your Gemfile As we are using custom directory 
for bot files we need to make sure that rails “knows” about it.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="c1"># config/initializers/messenger_bot.rb</span>

 <span class="k">unless</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">env</span><span class="p">.</span><span class="nf">production?</span>
   <span class="n">bot_files</span> <span class="o">=</span> <span class="no">Dir</span><span class="p">[</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">'app'</span><span class="p">,</span> <span class="s1">'messenger_bot'</span><span class="p">,</span> <span class="s1">'**'</span><span class="p">,</span> <span class="s1">'*.rb'</span><span class="p">)]</span>
   <span class="n">bot_reloader</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">FileUpdateChecker</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">bot_files</span><span class="p">)</span> <span class="k">do</span>
     <span class="n">bot_files</span><span class="p">.</span><span class="nf">each</span><span class="p">{</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span> <span class="n">require_dependency</span> <span class="n">file</span> <span class="p">}</span>
   <span class="k">end</span>
 
   <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Callbacks</span><span class="p">.</span><span class="nf">to_prepare</span> <span class="k">do</span>
     <span class="n">bot_reloader</span><span class="p">.</span><span class="nf">execute_if_updated</span>
   <span class="k">end</span>
 
   <span class="n">bot_files</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span> <span class="n">require_dependency</span> <span class="n">file</span> <span class="p">}</span>
 <span class="k">end</span>
 
<span class="c1"># config/application.rb</span>
<span class="nb">require_relative</span> <span class="s1">'boot'</span>

<span class="nb">require</span> <span class="s2">"rails"</span>
<span class="c1"># Pick the frameworks you want:</span>
<span class="nb">require</span> <span class="s2">"active_model/railtie"</span>
<span class="nb">require</span> <span class="s2">"active_job/railtie"</span>
<span class="nb">require</span> <span class="s2">"active_record/railtie"</span>
<span class="nb">require</span> <span class="s2">"action_controller/railtie"</span>
<span class="nb">require</span> <span class="s2">"action_mailer/railtie"</span>
<span class="nb">require</span> <span class="s2">"action_view/railtie"</span>
<span class="nb">require</span> <span class="s2">"action_cable/engine"</span>
<span class="nb">require</span> <span class="s2">"sprockets/railtie"</span>

<span class="c1"># Require the gems listed in Gemfile, including any gems</span>
<span class="c1"># you've limited to :test, :development, or :production.</span>
<span class="no">Bundler</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="o">*</span><span class="no">Rails</span><span class="p">.</span><span class="nf">groups</span><span class="p">)</span>
<span class="no">Dotenv</span><span class="o">::</span><span class="no">Railtie</span><span class="p">.</span><span class="nf">load</span>

<span class="k">module</span> <span class="nn">LifelogBot</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="c1"># Settings in config/environments/* take precedence over those specified here.</span>
    <span class="c1"># Application configuration should go into files in config/initializers</span>
    <span class="c1"># -- all .rb files in that directory are automatically loaded.</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">paths</span><span class="p">.</span><span class="nf">add</span> <span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">'app'</span><span class="p">,</span> <span class="s1">'bot'</span><span class="p">),</span> <span class="ss">glob: </span><span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">'**'</span><span class="p">,</span> <span class="s1">'*.rb'</span><span class="p">)</span>
    <span class="n">config</span><span class="p">.</span><span class="nf">autoload_paths</span> <span class="o">+=</span> <span class="no">Dir</span><span class="p">[</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">'app'</span><span class="p">,</span> <span class="s1">'bot'</span><span class="p">,</span> <span class="s1">'*'</span><span class="p">)]</span>
  <span class="k">end</span>
<span class="k">end</span>


<span class="c1"># config/routes.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">mount</span> <span class="no">Facebook</span><span class="o">::</span><span class="no">Messenger</span><span class="o">::</span><span class="no">Server</span><span class="p">,</span> <span class="ss">at: </span><span class="s1">'webhooks/messenger'</span>
<span class="k">end</span>

</code></pre>
</div>

<p>In order to successfully communicate with facebook api 
from you dev environment, you need to share access to your 
local machine somehow, and for this purposes I would suggest 
to use pretty great tool ngrok. Run your rails server using
<code class="highlighter-rouge">bundle exec rails server</code> and 
then open new shell and run <code class="highlighter-rouge">ngrok http 3000</code> 
where 3000 it can be any port where your rails app 
is currently bound. Quick note: if you are starting your app 
at first time don’t forget to run <code class="highlighter-rouge">rails db:create</code></p>

<p>The next thing you will need are tokens from 
facebook developer console, you will need to get: 
page access token, verify token for incoming webhooks 
and app token, all these tokens you can get from developer 
console.</p>

<p>As I have provided .env support to 
the starter repo you can add .env file and include the 
following keys there</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="nv">ACCESS_TOKEN</span><span class="o">=</span>YOURTOKEN
<span class="nv">APP_SECRET</span><span class="o">=</span>YOURSECRET
<span class="nv">VERIFY_TOKEN</span><span class="o">=</span>YOURVERIFYTOKEN
</code></pre>
</div>

<p><a href="/assets/posts/webhook-explained.png" class="fluidbox-trigger">
  <img src="/assets/posts/webhook-explained.png" alt="Idea of bot" />
</a></p>

<p>After you have successfully obtained all the required tokens you should add your 
url provided by ngrok to the facebook webhook settings.</p>

<p>After that, let’s write some basic code to test if everything works.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code>
<span class="nb">require</span> <span class="s1">'facebook/messenger'</span>

<span class="kp">include</span> <span class="no">Facebook</span><span class="o">::</span><span class="no">Messenger</span>

<span class="no">Bot</span><span class="p">.</span><span class="nf">on</span> <span class="ss">:message</span> <span class="k">do</span> <span class="o">|</span><span class="n">message</span><span class="o">|</span>
  <span class="n">message</span><span class="p">.</span><span class="nf">id</span>          <span class="c1"># =&gt; 'mid.1457764197618:41d102a3e1ae206a38'</span>
  <span class="n">message</span><span class="p">.</span><span class="nf">sender</span>      <span class="c1"># =&gt; { 'id' =&gt; '1008372609250235' }</span>
  <span class="n">message</span><span class="p">.</span><span class="nf">seq</span>         <span class="c1"># =&gt; 73</span>
  <span class="n">message</span><span class="p">.</span><span class="nf">sent_at</span>     <span class="c1"># =&gt; 2016-04-22 21:30:36 +0200</span>
  <span class="n">message</span><span class="p">.</span><span class="nf">text</span>        <span class="c1"># =&gt; 'Hello, bot!'</span>
  <span class="n">message</span><span class="p">.</span><span class="nf">attachments</span> <span class="c1"># =&gt; [ { 'type' =&gt; 'image', 'payload' =&gt; { 'url' =&gt; 'https://www.example.com/1.jpg' } } ]</span>

  <span class="n">message</span><span class="p">.</span><span class="nf">reply</span><span class="p">(</span><span class="ss">text: </span><span class="s1">'Hello, human!'</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>
<p>Then we can restart our rails server, 
find our facebook page name in messenger and simply write a 
message in our case let it be <strong><em>hello bot</em></strong> . According to the code 
example we should respond with simple: <strong><em>hello human</em></strong></p>

<p><a href="/assets/posts/hapiness.png" class="fluidbox-trigger">
  <img src="/assets/posts/hapiness.png" alt="hapiness" />
</a></p>

<p>Yay! We have basic skeleton for our bot!</p>

<h4 id="whats-next">What’s next?</h4>
<p>In this part we have successfully defined scope of our small project, provided basic bot structure, prepared all required dependencies so that we can move forward. In the next parts we will deep dive into implementation of setup phase we will touch different messenger specific ui elements and even implement basic natural language processing support. See you in the next part!</p>

          </div>

          <div class="article-share">
            
            <a href="" title="Share on Twitter" onclick="window.open('https://twitter.com/home?status=Bots on Rails. Part one: looking for an idea an... - http://nohype.tech/posts/bots-on-rails-part-1 by @makefunstuff', 'newwindow', 'width=500, height=225'); return false;" data-turbolinks="false">
              <svg enable-background="new 0 0 128 128" width="15px" version="1.1" viewBox="0 0 128 128" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="_x37__stroke"><g id="Twitter"><rect clip-rule="evenodd" fill="none" fill-rule="evenodd" height="128" width="128"/><path clip-rule="evenodd" d="M128,23.294    c-4.703,2.142-9.767,3.59-15.079,4.237c5.424-3.328,9.587-8.606,11.548-14.892c-5.079,3.082-10.691,5.324-16.687,6.526    c-4.778-5.231-11.608-8.498-19.166-8.498c-14.493,0-26.251,12.057-26.251,26.927c0,2.111,0.225,4.16,0.676,6.133    C41.217,42.601,21.871,31.892,8.91,15.582c-2.261,3.991-3.554,8.621-3.554,13.552c0,9.338,4.636,17.581,11.683,22.412    c-4.297-0.131-8.355-1.356-11.901-3.359v0.331c0,13.051,9.053,23.937,21.074,26.403c-2.201,0.632-4.523,0.948-6.92,0.948    c-1.69,0-3.343-0.162-4.944-0.478c3.343,10.694,13.035,18.483,24.53,18.691c-8.986,7.227-20.315,11.533-32.614,11.533    c-2.119,0-4.215-0.123-6.266-0.37c11.623,7.627,25.432,12.088,40.255,12.088c48.309,0,74.717-41.026,74.717-76.612    c0-1.171-0.023-2.342-0.068-3.49C120.036,33.433,124.491,28.695,128,23.294" fill-rule="evenodd" id="Twitter_1_"/></g></g></svg>
            </a>
            <a href="" title="Share on Facebook" onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=http://nohype.tech/posts/bots-on-rails-part-1', 'newwindow', 'width=500, height=500'); return false;" data-turbolinks="false">
              <svg enable-background="new 0 0 128 128" width="15px" version="1.1" viewBox="0 0 128 128" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="_x31__stroke"><g id="Facebook_1_"><rect fill="none" height="128" width="128"/><path clip-rule="evenodd" d="M68.369,128H7.065C3.162,128,0,124.836,0,120.935    V7.065C0,3.162,3.162,0,7.065,0h113.871C124.837,0,128,3.162,128,7.065v113.87c0,3.902-3.163,7.065-7.064,7.065H88.318V78.431    h16.638l2.491-19.318H88.318V46.78c0-5.593,1.553-9.404,9.573-9.404l10.229-0.004V20.094c-1.769-0.235-7.841-0.761-14.906-0.761    c-14.749,0-24.846,9.003-24.846,25.535v14.246H51.688v19.318h16.681V128z" fill-rule="evenodd" id="Facebook"/></g></g></svg>
            </a>
            <a href="" title="Share on Google+" onclick="window.open('https://plus.google.com/share?url=http://nohype.tech/posts/bots-on-rails-part-1', 'newwindow', 'width=550, height=400'); return false;" data-turbolinks="false">
              <svg enable-background="new 0 0 128 128" version="1.1" viewBox="0 0 128 128" width="20px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="_x35__stroke"><g id="Google_Plus"><rect clip-rule="evenodd" fill="none" fill-rule="evenodd" height="128" width="128"/><path clip-rule="evenodd" d="M40.654,55.935v16.13    c0,0,15.619-0.021,21.979-0.021C59.189,82.5,53.834,88.194,40.654,88.194c-13.338,0-23.748-10.832-23.748-24.194    s10.41-24.194,23.748-24.194c7.052,0,11.607,2.483,15.784,5.944c3.344-3.35,3.065-3.828,11.573-11.877    c-7.222-6.586-16.822-10.6-27.357-10.6C18.201,23.273,0,41.507,0,64c0,22.493,18.201,40.727,40.654,40.727    c33.561,0,41.763-29.275,39.044-48.792H40.654z M113.912,56.742V42.628h-10.063v14.113H89.358v10.081h14.491v14.517h10.063V66.823    H128V56.742H113.912z" fill-rule="evenodd" id="Google_Plus_1_"/></g></g></svg>
            </a>
          </div>

          
            <div id="disqus_thread" class="article-comments"></div>
            <script>
              (function() {
                  var d = document, s = d.createElement('script');
                  s.src = '//nohype-tech.disqus.com/embed.js';
                  s.setAttribute('data-timestamp', +new Date());
                  (d.head || d.body).appendChild(s);
              })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          
        </article>
        <footer class="footer reveal">
  <p>
    Think and <3 ruby
  </p>
</footer>

      </div>
    </div>
  </main>
  <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.16/webfont.js"></script>
<script>
  WebFont.load({
    google: {
      families: ['Cormorant Garamond:700', 'Lato:300,400,700']
    }
  });
</script>



<script type="text/javascript" src="/assets/vendor.js"></script>
<script type="text/javascript" src="/assets/application.js"></script>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-92620030-1', 'auto');
    ga('send', 'pageview');

</script>
</body>
</html>
